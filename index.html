<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>収支入力ページ</title>
    <!-- Tailwind CSSを読み込む -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* フォントをInterに設定 */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #121212; /* さらに暗い背景色 */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* 画面全体をカバー */
            margin: 0;
            padding: 20px; /* 全体のパディング */
            box-sizing: border-box;
            color: #cccccc; /* 全体的なテキスト色を少し暗く */
        }
        .container {
            background-color: #1e1e1e; /* さらに暗いコンテナ背景色 */
            padding: 2.5rem; /* 40px */
            border-radius: 1.5rem; /* 24px */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.25); /* シャドウをさらに濃く */
            width: 100%;
            max-width: 700px; /* 最大幅を少し広げる */
        }
        .form-group {
            display: flex;
            align-items: flex-start; /* ラベルと入力欄の上を揃える */
            margin-bottom: 1rem; /* 16px */
            width: 100%; /* Flexアイテム内で均等に広がるように設定 */
        }
        .form-group.hidden { /* 非表示にするためのクラス */
            display: none;
        }
        .form-group label {
            flex: 0 0 100px; /* ラベルの幅を固定 */
            margin-right: 1rem; /* 16px */
            color: #b0b0b0; /* ラベルのテキスト色を少し暗く */
            font-size: 0.95rem;
            padding-top: 0.65rem; /* inputのpaddingと高さを合わせる */
        }
        /* inputとselectの両方に適用されるスタイル */
        .form-group input,
        .form-group select {
            flex: 1; /* 入力フィールドが残りのスペースを埋める */
            padding: 0.65rem 0.5rem; /* 10.4px 8px (horizontal padding reduced) */
            border: 1px solid #333333; /* 枠線をさらに暗く */
            border-radius: 0.5rem; /* 8px */
            outline: none;
            transition: border-color 0.2s, background-color 0.2s, color 0.2s;
            min-width: 0; /* flexアイテムの最小幅を設定 */
            background-color: #282828; /* 入力フィールドの背景色をさらに暗く */
            color: #cccccc; /* 入力フィールドのテキスト色を少し暗く */
            box-sizing: border-box; /* padding/borderがwidthに影響しないように */
        }
        /* inputとselectの両方に適用されるフォーカス時のスタイル */
        .form-group input:focus,
        .form-group select:focus {
            border-color: #63b3ed; /* フォーカス時の枠線色は維持（視認性のため） */
            box-shadow: 0 0 0 3px rgba(99, 179, 237, 0.3); /* フォーカス時のシャドウを調整 */
        }
        /* Readonlyのinputフィールドのスタイルを明示的に設定 */
        .form-group input[readonly] {
            background-color: #282828; /* 他の入力フィールドと同じ背景色 */
            color: #cccccc; /* 他の入力フィールドと同じ文字色 */
            cursor: default; /* カーソルをデフォルトに */
            opacity: 0.9; /* 少し透明度を下げて非編集であることを強調 */
        }
        /* Disabledのselectフィールドのスタイル */
        .form-group select[disabled] {
            background-color: #282828; /* 他の入力フィールドと同じ背景色 */
            color: #cccccc; /* 他の入力フィールドと同じ文字色 */
            cursor: default; /* カーソルをデフォルトに */
            opacity: 0.9; /* 少し透明度を下げて非選択であることを強調 */
        }
        .title {
            text-align: center;
            font-size: 1.875rem; /* 30px */
            font-weight: bold;
            color: #cccccc; /* タイトルのテキスト色を少し暗く */
            margin-bottom: 2rem; /* 32px */
        }
        .submit-button {
            width: 100%;
            padding: 0.85rem; /* 13.6px */
            background-color: #3b82f6; /* ボタンの背景色を青に変更 */
            color: #ffffff;
            font-weight: bold;
            border-radius: 0.75rem; /* 12px */
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            border: none; /* 枠線をなくす */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.12); /* ボタンのシャドウを調整 */
        }
        .submit-button:hover {
            background-color: #2563eb; /* ホバー時の色を濃い青に変更 */
            transform: translateY(-1px); /* 少し上に移動 */
        }
        .submit-button:active {
            transform: translateY(0); /* クリック時に戻る */
        }

        /* 必須項目マークのスタイル */
        .required-mark {
            color: #ef4444; /* 赤色 */
            margin-left: 0.25rem; /* スペース */
            font-weight: bold;
            font-size: 0.8em;
            vertical-align: super;
        }

        /* Custom Alert Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #1e1e1e;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            width: 90%;
            max-width: 400px;
            text-align: center;
            color: #cccccc;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        .modal-overlay.show .modal-content {
            transform: translateY(0);
        }
        .modal-content h3 {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
            /* color will be set dynamically based on type of message */
        }
        .modal-content p {
            margin-bottom: 1.5rem;
            font-size: 1rem;
            line-height: 1.5;
        }
        .modal-close-button {
            background-color: #3b82f6;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s;
        }
        .modal-close-button:hover {
            background-color: #2563eb;
        }

        /* 横並びのグループのスタイル */
        .flex-group-wrapper {
            display: flex;
            gap: 1rem; /* グループ間のスペース */
            margin-bottom: 1rem; /* 通常のform-groupと同じマージン */
            width: 100%; /* 親要素の幅いっぱいに広げる */
            flex-wrap: wrap; /* 要素が収まらない場合に折り返す */
        }
        .flex-group-wrapper .form-group {
            margin-bottom: 0; /* ラッパー内のform-groupのマージンをリセット */
            flex: 1 1 calc(33.33% - 0.66rem); /* デフォルトで3分割を試みる */
            min-width: 150px; /* 最小幅を設定して小さくなりすぎないように */
        }
        /* 2つの要素を持つflex-group-wrapperの調整 */
        .flex-group-wrapper:has(> .form-group:nth-child(2)):not(:has(> .form-group:nth-child(3))) .form-group {
            flex: 1 1 calc(50% - 0.5rem); /* 2分割 */
            min-width: 200px;
        }

        /* レスポンシブデザイン */
        @media (max-width: 600px) {
            .container {
                padding: 1.5rem; /* 小さい画面でのパディング */
            }
            .title {
                font-size: 1.5rem; /* 小さい画面でのタイトルサイズ */
            }
            
            /* 個々のフォームグループ (ラベルと入力欄) は横並びを維持 */
            .form-group {
                flex-direction: row; /* モバイルでも横並びを維持 */
                align-items: center; /* 垂直方向中央揃え */
                margin-bottom: 0.75rem; /* 間隔を調整 */
            }
            .form-group label {
                flex: 0 0 80px; /* ラベルの幅を固定 (少し狭く) */
                margin-right: 0.5rem; /* ラベルと入力の間のスペース */
                padding-top: 0; /* リセット */
                text-align: right; /* ラベルを右寄せにして入力フィールドと揃える */
                font-size: 0.875rem; /* ラベルのフォントサイズを調整 */
            }
            .form-group input,
            .form-group select {
                flex: 1; /* 入力フィールドが残りのスペースを埋める */
                width: 100%; /* Ensure width is 100% of its flex container */
                max-width: 100%; /* Prevent it from exceeding 100% */
                box-sizing: border-box; /* Crucial for preventing overflow due to padding/border */
                min-width: 0; /* Allow inputs to shrink as much as possible */
            }

            /* For the container holding date-input and flex-db-fields */
            /* This div is the flex item that sits next to the 'Date' label */
            #date-form-group > div.flex-1 {
                width: calc(100% - 80px - 0.5rem); /* Total available width - label width - label margin */
                flex-basis: auto;
                flex-grow: 1; /* Allow to grow */
                flex-shrink: 1; /* Allow to shrink */
                min-width: 0; /* Allow to shrink to 0 */
                box-sizing: border-box;
            }

            /* Date input itself, inside the above div */
            #date-input {
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
                min-width: 0;
            }
            
            /* Day/Month/Year DB fields container */
            .flex-db-fields {
                flex-direction: column; /* 縦並びに変更 */
                gap: 0.5rem; /* 各DBフィールド間の縦方向のスペース */
                width: 100%;
                margin-top: 0.5rem;
                box-sizing: border-box;
                align-items: flex-start; /* ラベルと入力欄を左寄せに */
            }
            /* Individual DB field containers (年月日DB, 年DB, 年月DB) */
            .flex-db-fields > div {
                flex: 1 1 100%; /* 各要素が横幅いっぱいになるように設定 */
                min-width: unset; /* 最小幅をリセット */
                box-sizing: border-box;
                display: flex; /* ラベルと入力は横並びを維持 */
                align-items: center;
            }
            /* Labels inside DB fields */
            .flex-db-fields > div label { 
                flex-shrink: 0;
                width: 65px; /* ラベルの幅を少し広げてテキストが見えるように */
                margin-right: 0.2rem; /* マージンを調整 */
                font-size: 0.75rem; /* フォントサイズを調整 */
                text-align: left; /* ラベルを左寄せに */
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                padding-top: 0;
            }
            /* Inputs inside DB fields */
            .flex-db-fields > div input {
                flex: 1;
                width: 100%; /* 入力欄が残りのスペースを埋める */
                max-width: 100%;
                box-sizing: border-box;
                min-width: 0;
                font-size: 0.85rem; /* 入力欄のフォントサイズを調整 */
                padding: 0.4rem 0.3rem; /* パディングを調整 */
            }

            /* 横並びのグループを縦に並べる */
            .flex-group-wrapper {
                flex-direction: column; /* 縦並びに変更 */
                gap: 0.75rem;
                margin-bottom: 0.75rem;
            }
            .flex-group-wrapper .form-group {
                width: 100%; /* 横幅いっぱいに */
                flex: none; /* flexプロパティをリセット */
                min-width: unset; /* min-widthをリセット */
                box-sizing: border-box;
            }

            /* Ensure dynamic input containers also correctly constrain their children */
            #location-store-input-container,
            #class-input-container,
            #condition-input-container,
            #race-name-input-container,
            #horse-name-input-container,
            #device-type-input-container,
            #type-input-container,
            #manufacturer-input-container {
                flex: 1;
                width: 100%;
                max-width: 100%;
                min-width: 0;
                box-sizing: border-box;
            }
        }

        /* 収支の表示枠を無くす */
        #balance-input[readonly] {
            border: none !important; /* 枠線をなくす */
            box-shadow: none !important; /* シャドウをなくす */
            background-color: transparent !important; /* 背景を透明にする */
            padding-left: 0 !important; /* 左パディングをなくすことで枠と重なるのを防ぐ */
            padding-right: 0 !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">収支入力ページ</h1>

        <form id="expense-form">
            <div class="form-group" id="title-form-group">
                <label for="title-input">タイトル</label>
                <input type="text" id="title-input" placeholder="タイトルを入力" class="rounded-lg">
            </div>

            <div class="form-group" id="category-form-group">
                <label for="category-select">カテゴリ<span id="category-required" class="required-mark">*</span></label>
                <select id="category-select" class="rounded-lg" required>
                    <option value="">選択してください</option>
                    <option value="競馬">競馬</option>
                    <option value="地方競馬">地方競馬</option>
                    <option value="競艇">競艇</option>
                    <option value="競輪">競輪</option>
                    <option value="オートレース">オートレース</option>
                    <option value="パチンコ">パチンコ</option>
                    <option value="スロット">スロット</option>
                    <option value="ポーカー">ポーカー</option>
                    <option value="麻雀">麻雀</option>
                    <option value="その他">その他</option>
                </select>
            </div>

            <div class="form-group" id="date-form-group">
                <label for="date-input">Date<span id="date-required" class="required-mark hidden">*</span></label>
                <div class="flex-1 flex flex-col gap-y-2">
                    <input type="date" id="date-input" class="rounded-lg w-full">
                    <div class="flex flex-col gap-y-2 flex-db-fields">
                        <!-- 年月日DBフィールド -->
                        <div class="flex items-center" id="date-db-form-group">
                            <label for="date-db-input" class="text-sm font-medium text-[#b0b0b0] mr-1">年月日DB</label>
                            <input type="text" id="date-db-input" placeholder="2024年" class="rounded-lg flex-1" readonly tabindex="-1">
                        </div>
                        <!-- 年月DBフィールド (ここに移動) -->
                        <div class="flex items-center" id="month-date-db-form-group">
                            <label for="month-date-db-input" class="text-sm font-medium text-[#b0b0b0] mr-1">年月DB</label>
                            <input type="text" id="month-date-db-input" placeholder="2024年6月" class="rounded-lg flex-1" readonly tabindex="-1">
                        </div>
                        <!-- 年DBフィールド (ここに移動) -->
                        <div class="flex items-center" id="year-db-form-group">
                            <label for="year-db-input" class="text-sm font-medium text-[#b0b0b0] mr-1">年DB</label>
                            <input type="text" id="year-db-input" placeholder="6月" class="rounded-lg flex-1" readonly tabindex="-1">
                        </div>
                    </div>
                </div>
            </div>

            <!-- 場名・店名とレース番号を横並びに -->
            <div class="flex-group-wrapper">
                <div class="form-group flex-1" id="location-store-form-group">
                    <label for="location-store-input-label">場名・店名<span id="location-store-required" class="required-mark hidden">*</span></label>
                    <div id="location-store-input-container" class="flex-1 w-full">
                        <input type="text" id="location-store-input" placeholder="場名・店名を入力" class="rounded-lg w-full">
                    </div>
                </div>

                <div class="form-group flex-1" id="race-number-form-group">
                    <label for="race-number-select">レース番号<span id="race-number-required" class="required-mark hidden">*</span></label>
                    <div class="flex-1 flex items-center gap-2"> <!-- Added flex container here -->
                        <select id="race-number-select" class="rounded-lg flex-1">
                            <option value="">選択してください</option>
                            <option value="1R">1R</option>
                            <option value="2R">2R</option>
                            <option value="3R">3R</option>
                            <option value="4R">4R</option>
                            <option value="5R">5R</option>
                            <option value="6R">6R</option>
                            <option value="7R">7R</option>
                            <option value="8R">8R</option>
                            <option value="9R">9R</option>
                            <option value="10R">10R</option>
                            <option value="11R">11R</option>
                            <option value="12R">12R</option>
                            <option value="重勝式">重勝式</option>
                        </select>
                        <button type="button" id="web-search-button" class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-lg flex-shrink-0" title="Web検索">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-external-link">
                                <path d="M15 3h6v6"/><path d="M10 14 21 3"/><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="form-group" id="event-date-form-group">
                <label for="event-date-select">開催日<span id="event-date-required" class="required-mark hidden">*</span></label>
                <select id="event-date-select" class="rounded-lg">
                    <option value="">選択してください</option>
                    <option value="1日目">1日目</option>
                    <option value="2日目">2日目</option>
                    <option value="3日目">3日目</option>
                    <option value="4日目">4日目</option>
                    <option value="5日目">5日目</option>
                    <option value="6日目">6日目</option>
                    <option value="7日目">7日目</option>
                </select>
            </div>

            <div class="form-group" id="race-name-form-group">
                <label for="race-name-input-label">レース名</label>
                <div id="race-name-input-container" class="flex-1 w-full">
                    <input type="text" id="race-name-input" placeholder="レース名を入力" class="rounded-lg w-full">
                </div>
            </div>

            <div class="form-group" id="class-form-group">
                <label for="class-input-label">クラス<span id="class-required" class="required-mark hidden">*</span></label>
                <div id="class-input-container" class="flex-1 w-full">
                    <input type="text" id="class-input" placeholder="クラスを入力" class="rounded-lg w-full">
                </div>
            </div>

            <!-- 馬場、距離、距離ジャンルを横並びに -->
            <div class="flex-group-wrapper">
                <div class="form-group flex-1" id="horse-name-form-group">
                    <label for="horse-name-input-label">馬場<span id="horse-name-required" class="required-mark hidden">*</span></label>
                    <div id="horse-name-input-container" class="flex-1 w-full">
                        <input type="text" id="horse-name-input" placeholder="馬場を入力" class="rounded-lg w-full">
                    </div>
                </div>
                <div class="form-group flex-1" id="distance-form-group">
                    <label for="distance-select">距離<span id="distance-required" class="required-mark hidden">*</span></label>
                    <select id="distance-select" class="rounded-lg">
                        <option value="">選択してください</option>
                        <option value="1000">1,000m</option>
                        <option value="1100">1,100m</option>
                        <option value="1200">1,200m</option>
                        <option value="1230">1,230m</option>
                        <option value="1300">1,300m</option>
                        <option value="1400">1,400m</option>
                        <option value="1500">1,500m</option>
                        <option value="1600">1,600m</option>
                        <option value="1700">1,700m</option>
                        <option value="1800">1,800m</option>
                        <option value="1900">1,900m</option>
                        <option value="2000">2,000m</option>
                        <option value="2100">2,100m</option>
                        <option value="2200">2,200m</option>
                        <option value="2300">2,300m</option>
                        <option value="2400">2,400m</option>
                        <option value="2500">2,500m</option>
                        <option value="2600">2,600m</option>
                        <option value="2700">2,700m</option>
                        <option value="2800">2,800m</option>
                        <option value="2900">2,900m</option>
                        <option value="3000">3,000m</option>
                        <option value="3100">3,100m</option>
                        <option value="3200">3,200m</option>
                        <option value="3300">3,300m</option>
                        <option value="3400">3,400m</option>
                        <option value="3500">3,500m</option>
                        <option value="3600">3,600m</option>
                        <option value="4100">4,100m</option>
                        <option value="4250">4,250m</option>
                        <option value="820">820m</option>
                        <option value="その他">その他</option>
                    </select>
                </div>
                <div class="form-group flex-1" id="distance-genre-form-group">
                    <label for="distance-genre-input">距離ジャンル</label>
                    <input type="text" id="distance-genre-input" placeholder="自動反映" class="rounded-lg" readonly tabindex="-1">
                </div>
            </div>

            <!-- 条件は単独の行に配置 -->
            <div class="form-group" id="condition-form-group">
                <label for="condition-input">条件</label>
                <div id="condition-input-container" class="flex-1 w-full">
                    <input type="text" id="condition-input" placeholder="条件を入力" class="rounded-lg w-full">
                </div>
            </div>

            <div class="form-group" id="betting-type-form-group">
                <label for="betting-type-select">券種<span id="betting-type-required" class="required-mark hidden">*</span></label>
                <select id="betting-type-select" class="rounded-lg">
                    <option value="">選択してください</option>
                    <option value="単勝">単勝</option>
                    <option value="複勝">複勝</option>
                    <option value="枠連">枠連</option>
                    <option value="馬連">馬連</option>
                    <option value="馬単">馬単</option>
                    <option value="ワイド">ワイド</option>
                    <option value="3連複">3連複</option>
                    <option value="3連単">3連単</option>
                    <option value="WIN5">WIN5</option>
                    <option value="枠単">枠単</option>
                    <option value="2連複">2連複</option>
                    <option value="2連単">2連単</option>
                    <option value="Dokanto.7">Dokanto.7</option>
                </select>
            </div>

            <!-- 支出、収入、収支を横並びに -->
            <div class="flex-group-wrapper">
                <div class="form-group flex-1" id="expense-form-group">
                    <label for="expense-input">支出<span id="expense-required" class="required-mark hidden">*</span></label>
                    <input type="number" id="expense-input" placeholder="支出額を入力" class="rounded-lg" step="100" min="0">
                </div>

                <div class="form-group flex-1" id="income-form-group">
                    <label for="income-input">収入<span id="income-required" class="required-mark hidden">*</span></label>
                    <input type="number" id="income-input" placeholder="収入額を入力" class="rounded-lg" min="0">
                </div>

                <div class="form-group flex-1" id="balance-form-group">
                    <label for="balance-input">収支</label>
                    <input type="text" id="balance-input" placeholder="自動計算" class="rounded-lg" readonly tabindex="-1">
                </div>
            </div>

            <!-- 機種、タイプ、メーカーを横並びに -->
            <div class="flex-group-wrapper">
                <div class="form-group flex-1" id="device-type-form-group">
                    <label for="device-type-label">機種<span id="device-type-required" class="required-mark hidden">*</span></label>
                    <div id="device-type-input-container" class="flex-1 w-full">
                        <input type="text" id="device-type-input" placeholder="機種を入力" class="rounded-lg w-full">
                    </div>
                </div>

                <div class="form-group flex-1" id="type-form-group">
                    <label for="type-label">タイプ<span id="type-required" class="required-mark hidden">*</span></label>
                    <div id="type-input-container" class="flex-1 w-full">
                        <input type="text" id="type-input" placeholder="タイプを入力" class="rounded-lg w-full">
                    </div>
                </div>

                <div class="form-group flex-1" id="manufacturer-form-group">
                    <label for="manufacturer-label">メーカー<span id="manufacturer-required" class="required-mark hidden">*</span></label>
                    <div id="manufacturer-input-container" class="flex-1 w-full">
                        <input type="text" id="manufacturer-input" placeholder="メーカーを入力" class="rounded-lg w-full">
                    </div>
                </div>
            </div>

            <div class="form-group" id="media-form-group">
                <label for="media-input">Media</label>
                <input type="text" id="media-input" placeholder="Mediaを入力" class="rounded-lg">
            </div>

            <div class="form-group" id="memo-form-group">
                <label for="memo-input">メモ</label>
                <input type="text" id="memo-input" placeholder="メモを入力" class="rounded-lg">
            </div>

            <button type="submit" class="submit-button">送信</button>
        </form>
    </div>

    <!-- Custom Alert Modal -->
    <div id="custom-alert-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="alert-title"></h3> <!-- Changed from static to dynamic -->
            <p id="alert-message"></p>
            <button id="alert-close-button" class="modal-close-button">閉じる</button>
        </div>
    </div>
    
    <!-- Loading Modal -->
    <div id="loading-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500 mx-auto"></div>
            <p class="mt-4 text-white">Notionにデータを送信中...</p>
        </div>
    </div>


    <script>
        // *** GAS Web App URLをここに貼り付けてください ***
        // Google Apps Scriptをデプロイした後に得られるURL
        const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxCL1CEojedVkUoGXYf6M0nL2kAT77mvUbmLu11qFWFhNDWfNguPCYXcjC4iaSehOCGuw/exec"; 

        // カテゴリーに応じた場名・店名の候補データ
        const locationData = {
            "競馬": [
                "札幌", "函館", "福島", "新潟", "東京", "中山", "中京", "京都", "阪神", "小倉"
            ],
            "地方競馬": [
                "帯広", "門別", "盛岡", "水沢", "浦和", "船橋", "大井", "川崎", "名古屋", "笠松", "園田", "姫路", "高知", "佐賀"
            ],
            "競艇": [
                "桐生", "戸田", "江戸川", "平和島", "多摩川", "浜名湖", "蒲郡", "常滑", "津", "三国", "びわこ", "住之江", "尼崎", "鳴門", "丸亀", "児島", "宮島", "徳山", "下関", "若松", "芦屋", "福岡", "唐津", "大村"
            ],
            "競輪": [
                "青森", "函館", "いわき平", "弥彦", "前橋", "取手", "宇都宮", "大宮", "西武園", "京王閣", "立川", "松戸", "千葉", "川崎", "平塚", "小田原", "伊東", "静岡", "名古屋", "岐阜", "豊橋", "福井", "奈良", "向日町", "和歌山", "岸和田", "玉野", "広島", "防府", "高松", "小松島", "小倉", "久留米", "武雄", "佐世保", "別府", "熊本"
            ],
            "オートレース": [
                "伊勢崎", "川口", "浜松", "山陽", "飯塚"
            ],
            "パチンコ": [],
            "スロット": [],
            "ポーカー": [],
            "麻雀": [],
            "その他": []
        };

        // カテゴリーに応じたクラスの候補データ
        const classData = {
            "競馬": [
                "GⅠ", "GⅡ", "GⅢ", "リステッド", "オープン", "3勝クラス", "2勝クラス", "1勝クラス", "未勝利", "新馬戦"
            ],
            "地方競馬": [
                "GⅠ", "GⅡ", "GⅢ", "オープン", "一般"
            ],
            "競艇": [
                "SG", "GⅠ", "GⅡ", "GⅢ", "一般"
            ],
            "競輪": [
                "SS", "S級1班", "S級2班", "A級1班", "A級2班", "A級3班"
            ],
            "オートレース": [
                "SG", "GⅠ", "GⅡ", "一般"
            ],
            "パチンコ": [],
            "स्ロット": [],
            "ポーカー": [],
            "麻雀": [],
            "その他": []
        };

        // カテゴリーに応じたレース名の候補データ
        const raceNameData = {
            "競馬": [
                "フェブラリーS", "高松宮記念", "大阪杯", "桜花賞", "中山グランドジャンプ", "皐月賞", "天皇賞（春）", "NHKマイルC", "ヴィクトリアマイル", "オークス", "日本ダービー", "安田記念", "宝塚記念", "スプリンターズS", "秋華賞", "菊花賞", "天皇賞（秋）", "エリザベス女王杯", "マイルチャンピオンシップ", "ジャパンC", "チャンピオンズC", "阪神ジュベナイルF", "朝日杯フューチュリティS", "有馬記念", "ホープフルS", "サウジカップ", "ドバイワールドカップ", "ドバイターフ", "ドバイシーマクラシック", "ドバイゴールデンシャヒーン", "香港ヴァーズ", "香港スプリント", "香港マイル", "香港カップ"
            ],
            "地方競馬": [
                "かしわ記念", "帝王賞", "ジャパンダートダービー", "日本テレビ盃", "JBCクラシック", "JBCスプリント", "JBCレディスクラシック", "全日本2歳優駿", "東京大賞典"
            ],
            "競艇": [
                "ボートレースダービー", "チャレンジカップ", "グランプリ", "クラシック", "オールスター", "メモリアル", "クイーンズクライマックス"
            ],
            "競輪": [
                "KEIRINグランプリ", "日本選手権競輪", "高松宮記念杯競輪", "オールスター競輪", "共同通信社杯", "寛仁親王牌・世界選手権競輪", "朝日新聞社杯競輪祭", "競輪祭", "読売新聞社杯全日本選抜競輪"
            ],
            "オートレース": [
                "日本選手権オートレース", "全日本選抜オートレース", "オールスターオートレース", "スーパースター王座決定戦", "SSシリーズ戦"
            ],
            "パチンコ": [],
            "スロット": [],
            "ポーカー": [],
            "麻雀": [],
            "その他": []
        };

        // カテゴリーと場名に応じた馬場の候補データ
        const horseNameData = {
            "競馬": {
                "札幌": ["芝", "ダート"], "函館": ["芝", "ダート"], "福島": ["芝", "ダート"], "新潟": ["芝", "ダート"],
                "東京": ["芝", "ダート"], "中山": ["芝", "ダート"], "中京": ["芝", "ダート"], "京都": ["芝", "ダート"],
                "阪神": ["芝", "ダート"], "小倉": ["芝", "ダート"]
            },
            "地方競馬": {
                "帯広": ["ダート"], "門別": ["ダート"], "盛岡": ["ダート"], "水沢": ["ダート"],
                "浦和": ["ダート"], "船橋": ["ダート"], "大井": ["ダート"],
                "川崎": ["ダート"], "名古屋": ["ダート"], "笠松": ["ダート"], "園田": ["ダート"],
                "姫路": ["ダート"], "高知": ["ダート"], "佐賀": ["ダート"]
            },
            "競艇": {
                "桐生": ["淡水"], "戸田": ["淡水"], "江戸川": ["海水"], "平和島": ["海水"],
                "多摩川": ["淡水"], "浜名湖": ["汽水"], "蒲郡": ["海水"], "常滑": ["海水"],
                "津": ["淡水"], "三国": ["淡水"], "びわこ": ["淡水"], "住之江": ["淡水"],
                "尼崎": ["淡水"], "鳴門": ["海水"], "丸亀": ["海水"], "児島": ["海水"],
                "宮島": ["海水"], "徳山": ["海水"], "下関": ["海水"], "若松": ["海水"],
                "芦屋": ["海水"], "福岡": ["海水"], "唐津": ["海水"], "大村": ["淡水"]
            },
            "競輪": {
                "青森": ["400m"], "函館": ["400m"], "いわき平": ["400m"], "弥彦": ["400m"],
                "前橋": ["333m"], "取手": ["400m"], "宇都宮": ["500m"], "大宮": ["500m"],
                "西武園": ["400m"], "京王閣": ["400m"], "立川": ["400m"], "松戸": ["333m"],
                "千葉": ["333m"], "川崎": ["400m"], "平塚": ["400m"], "小田原": ["333m"],
                "伊東": ["333m"], "静岡": ["400m"], "名古屋": ["400m"], "岐阜": ["400m"],
                "" /* 大垣など他の競輪場もここに追加 */ : ["400m", "333m", "500m"] // 例として汎用的なものも
            },
            "オートレース": {
                "伊勢崎": ["走路"], "川口": ["走路"], "浜松": ["走路"], "山陽": ["走路"], "飯塚": ["走路"]
            },
            "パチンコ": {}, "スロット": {}, "ポーカー": {}, "麻雀": {}, "その他": {}
        };

        // 距離に応じた距離ジャンルの候補データ
        const distanceGenreData = {
            "Sprint(スプリント)": [1000, 1300], // 1,000m - 1,300m
            "Mile(マイル)": [1301, 1899], // 1301m - 1899m
            "Intermediate(インターミディエイト)": [1900, 2100], // 1900m - 2100m
            "Long(ロング)": [2101, 2700], // 2101m - 2700m
            "Extended(エクステンデッド)": [2701] // 2701m以上
        };
        
        // カテゴリーに応じた条件の候補データ
        const conditionData = {
            "競馬": [
                "2歳牡・牝", "2歳牝", "3歳牡・牝", "3歳牝", "3歳以上", "3歳以上牝", "4歳以上", "4歳以上牝", "ハンデ戦" // 女子戦を除外
            ],
            "地方競馬": [
                "2歳牡・牝", "2歳牝", "3歳牡・牝", "3歳牝", "3歳以上", "3歳以上牝", "4歳以上", "4歳以上牝" // 女子戦を除外
            ],
            "競艇": [
                "ルーキーシリーズ", "マスターズ", "ドリーム戦", "準優勝戦", "優勝戦", "準優勝戦"
            ],
            "競輪": [
                "S級", "A級", "準決勝戦", "ガールズ", "チャレンジ", "決勝戦", "ミッドナイト"
            ],
            "オートレース": [],
            "パチンコ": [],
            "スロット": [],
            "ポーカー": [],
            "麻雀": [],
            "その他": []
        };

        // 機種詳細データ (機種からタイプとメーカーを導出)
        const deviceTypeDetails = {
            "かぐや様は告らせたい": { type: "AT", manufacturer: "SANKYO" },
            "モンキーターンV": { type: "AT", manufacturer: "山佐" },
            "SアイムジャグラーEX": { type: "A", manufacturer: "北電子" },
            "革命機ヴァルヴレイヴ": { type: "AT", manufacturer: "SANKYO" },
            "スマスロ ゴールデンカムイ": { type: "AT", manufacturer: "Sammy" },
            "ジャグラーガールズSS": { type: "A", manufacturer: "北電子" },
            "ファンキージャグラー2": { type: "A", manufacturer: "北電子" },
            "Re:ゼロから始める異世界生活 season2": { type: "AT", manufacturer: "大都技研" }
        };

        // 全機種リスト (deviceTypeDetailsのキーから生成)
        const allDeviceTypes = Object.keys(deviceTypeDetails);

        // タイプオプション
        const typeOptions = ["A", "RT", "ART", "AT", "A+RT"];
        // メーカーオプション
        const manufacturerOptions = ["北電子", "SANKYO", "Sammy", "大都技研", "山佐"];

        // 各フォームグループのIDをマップ
        let formGroups = {}; 

        // カテゴリーごとのフィールド表示/非表示、および必須設定 (★マークを反映)
        const visibilityMatrix = {
            "競馬": {
                "title": { visible: true, required: false },
                "category": { visible: true, required: true }, // カテゴリーは常に必須なので、ここに設定は残すが、別途強制する
                "date": { visible: true, required: true },
                "date-db": { visible: true, required: false },
                "year-db": { visible: true, required: false },
                "month-date-db": { visible: true, required: false },
                "location-store": { visible: true, required: true },
                "event-date": { visible: false, required: false },
                "race-number": { visible: true, required: true },
                "race-name": { visible: true, required: false },
                "class": { visible: true, required: true },
                "distance": { visible: true, required: true },
                "distance-genre": { visible: true, required: false },
                "condition": { visible: true, required: false },
                "horse-name": { visible: true, required: true },
                "betting-type": { visible: true, required: true },
                "expense": { visible: true, required: true },
                "income": { visible: true, required: true },
                "balance": { visible: true, required: false },
                "device-type": { visible: false, required: false },
                "type": { visible: false, required: false },
                "manufacturer": { visible: false, required: false },
                "media": { visible: true, required: false },
                "memo": { visible: true, required: false }
            },
            "地方競馬": {
                "title": { visible: true, required: false },
                "category": { visible: true, required: true },
                "date": { visible: true, required: true },
                "date-db": { visible: true, required: false },
                "year-db": { visible: true, required: false },
                "month-date-db": { visible: true, required: false },
                "location-store": { visible: true, required: true },
                "event-date": { visible: false, required: false },
                "race-number": { visible: true, required: true },
                "race-name": { visible: true, required: false },
                "class": { visible: true, required: true },
                "distance": { visible: true, required: true },
                "distance-genre": { visible: true, required: false },
                "condition": { visible: true, required: false },
                "horse-name": { visible: true, required: true },
                "betting-type": { visible: true, required: true },
                "expense": { visible: true, required: true },
                "income": { visible: true, required: true },
                "balance": { visible: true, required: false },
                "device-type": { visible: false, required: false },
                "type": { visible: false, required: false },
                "manufacturer": { visible: false, required: false },
                "media": { visible: true, required: false },
                "memo": { visible: true, required: false }
            },
            "競艇": {
                "title": { visible: true, required: false },
                "category": { visible: true, required: true },
                "date": { visible: true, required: true },
                "date-db": { visible: true, required: false },
                "year-db": { visible: true, required: false },
                "month-date-db": { visible: true, required: false },
                "location-store": { visible: true, required: true },
                "event-date": { visible: true, required: true },
                "race-number": { visible: true, required: true },
                "race-name": { visible: true, required: false },
                "class": { visible: true, required: true },
                "distance": { visible: true, required: true },
                "distance-genre": { visible: true, required: false },
                "condition": { visible: true, required: false },
                "horse-name": { visible: true, required: true },
                "betting-type": { visible: true, required: true },
                "expense": { visible: true, required: true },
                "income": { visible: true, required: true },
                "balance": { visible: true, required: false },
                "device-type": { visible: false, required: false },
                "type": { visible: false, required: false },
                "manufacturer": { visible: false, required: false },
                "media": { visible: true, required: false },
                "memo": { visible: true, required: false }
            },
            "競輪": {
                "title": { visible: true, required: false },
                "category": { visible: true, required: true },
                "date": { visible: true, required: true },
                "date-db": { visible: true, required: false },
                "year-db": { visible: true, required: false },
                "month-date-db": { visible: true, required: false },
                "location-store": { visible: true, required: true },
                "event-date": { visible: true, required: true },
                "race-number": { visible: true, required: true },
                "race-name": { visible: true, required: false },
                "class": { visible: true, required: true },
                "distance": { visible: true, required: true },
                "distance-genre": { visible: true, required: false },
                "condition": { visible: true, required: false },
                "horse-name": { visible: true, required: true },
                "betting-type": { visible: true, required: true },
                "expense": { visible: true, required: true },
                "income": { visible: true, required: true },
                "balance": { visible: true, required: false },
                "device-type": { visible: false, required: false },
                "type": { visible: false, required: false },
                "manufacturer": { visible: false, required: false },
                "media": { visible: true, required: false },
                "memo": { visible: true, required: false }
            },
            "オートレース": {
                "title": { visible: true, required: false },
                "category": { visible: true, required: true },
                "date": { visible: true, required: true },
                "date-db": { visible: true, required: false },
                "year-db": { visible: true, required: false },
                "month-date-db": { visible: true, required: false },
                "location-store": { visible: true, required: true },
                "event-date": { visible: true, required: true },
                "race-number": { visible: true, required: true },
                "race-name": { visible: true, required: false },
                "class": { visible: true, required: true },
                "distance": { visible: true, required: true },
                "distance-genre": { visible: true, required: false },
                "condition": { visible: true, required: false },
                "horse-name": { visible: false, required: false },
                "betting-type": { visible: true, required: true },
                "expense": { visible: true, required: true },
                "income": { visible: true, required: true },
                "balance": { visible: true, required: false },
                "device-type": { visible: false, required: false },
                "type": { visible: false, required: false },
                "manufacturer": { visible: false, required: false },
                "media": { visible: true, required: false },
                "memo": { visible: true, required: false }
            },
            "パチンコ": {
                "title": { visible: true, required: false },
                "category": { visible: true, required: true },
                "date": { visible: true, required: true },
                "date-db": { visible: true, required: false },
                "year-db": { visible: true, required: false },
                "month-date-db": { visible: true, required: false },
                "location-store": { visible: true, required: true },
                "event-date": { visible: false, required: false },
                "race-number": { visible: false, required: false },
                "race-name": { visible: false, required: false },
                "class": { visible: false, required: false },
                "distance": { visible: false, required: false },
                "distance-genre": { visible: false, required: false },
                "condition": { visible: false, required: false },
                "horse-name": { visible: false, required: false },
                "betting-type": { visible: false, required: false },
                "expense": { visible: true, required: true },
                "income": { visible: true, required: true },
                "balance": { visible: true, required: false },
                "device-type": { visible: true, required: true },
                "type": { visible: true, required: true },
                "manufacturer": { visible: true, required: true },
                "media": { visible: true, required: false },
                "memo": { visible: true, required: false }
            },
            "スロット": {
                "title": { visible: true, required: false },
                "category": { visible: true, required: true },
                "date": { visible: true, required: true },
                "date-db": { visible: true, required: false },
                "year-db": { visible: true, required: false },
                "month-date-db": { visible: true, required: false },
                "location-store": { visible: true, required: true },
                "event-date": { visible: false, required: false },
                "race-number": { visible: false, required: false },
                "race-name": { visible: false, required: false },
                "class": { visible: false, required: false },
                "distance": { visible: false, required: false },
                "distance-genre": { visible: false, required: false },
                "condition": { visible: false, required: false },
                "horse-name": { visible: false, required: false },
                "betting-type": { visible: false, required: false },
                "expense": { visible: true, required: true },
                "income": { visible: true, required: true },
                "balance": { visible: true, required: false },
                "device-type": { visible: true, required: true },
                "type": { visible: true, required: true },
                "manufacturer": { visible: true, required: true },
                "media": { visible: true, required: false },
                "memo": { visible: true, required: false }
            },
            "ポーカー": {
                "title": { visible: true, required: false },
                "category": { visible: true, required: true },
                "date": { visible: true, required: true },
                "date-db": { visible: true, required: false },
                "year-db": { visible: true, required: false },
                "month-date-db": { visible: true, required: false },
                "location-store": { visible: false, required: false },
                "event-date": { visible: false, required: false },
                "race-number": { visible: false, required: false },
                "race-name": { visible: false, required: false },
                "class": { visible: false, required: false },
                "distance": { visible: false, required: false },
                "distance-genre": { visible: false, required: false },
                "condition": { visible: false, required: false },
                "horse-name": { visible: false, required: false },
                "betting-type": { visible: false, required: false },
                "expense": { visible: true, required: true },
                "income": { visible: true, required: true },
                "balance": { visible: true, required: false },
                "device-type": { visible: false, required: false },
                "type": { visible: false, required: false },
                "manufacturer": { visible: false, required: false },
                "media": { visible: true, required: false },
                "memo": { visible: true, required: false }
            },
            "麻雀": {
                "title": { visible: true, required: false },
                "category": { visible: true, required: true },
                "date": { visible: true, required: true },
                "date-db": { visible: true, required: false },
                "year-db": { visible: true, required: false },
                "month-date-db": { visible: true, required: false },
                "location-store": { visible: false, required: false },
                "event-date": { visible: false, required: false },
                "race-number": { visible: false, required: false },
                "race-name": { visible: false, required: false },
                "class": { visible: false, required: false },
                "distance": { visible: false, required: false },
                "distance-genre": { visible: false, required: false },
                "condition": { visible: false, required: false },
                "horse-name": { visible: false, required: false },
                "betting-type": { visible: true, required: false },
                "expense": { visible: true, required: true },
                "income": { visible: true, required: true },
                "balance": { visible: true, required: false },
                "device-type": { visible: false, required: false },
                "type": { visible: false, required: false },
                "manufacturer": { visible: false, required: false },
                "media": { visible: true, required: false },
                "memo": { visible: true, required: false }
            },
            "その他": { // Default to required if visible, otherwise false
                "title": { visible: true, required: false },
                "category": { visible: true, required: true },
                "date": { visible: true, required: true },
                "date-db": { visible: true, required: false },
                "year-db": { visible: true, required: false },
                "month-date-db": { visible: true, required: false },
                "location-store": { visible: true, required: true },
                "event-date": { visible: true, required: true },
                "race-number": { visible: true, required: true },
                "race-name": { visible: true, required: false },
                "class": { visible: true, required: true },
                "distance": { visible: true, required: true },
                "distance-genre": { visible: true, required: false },
                "condition": { visible: true, required: false },
                "horse-name": { visible: true, required: true },
                "betting-type": { visible: true, required: true },
                "expense": { visible: true, required: true },
                "income": { visible: true, required: true },
                "balance": { visible: true, required: false },
                "device-type": { visible: true, required: true },
                "type": { visible: true, required: true },
                "manufacturer": { visible: true, required: true },
                "media": { visible: true, required: false },
                "memo": { visible: true, required: false }
            }
        };

        let categorySelect;
        let expenseForm;
        
        // Input Containers and Elements - DOMContentLoadedで初期化
        let locationStoreInputContainer;
        let classInputContainer;
        let raceNameInputContainer;
        let horseNameInputContainer;
        let distanceSelect;
        let distanceGenreInput;
        let conditionInputContainer;
        let deviceTypeInputContainer;
        let typeInputContainer;
        let manufacturerInputContainer;

        let dateInput;
        let dateDbInput;
        let yearDbInput;
        let monthDateDbInput;

        let expenseInput;
        let incomeInput;
        let balanceInput;
        
        // Add a reference to the web search button
        let webSearchButton;

        // Custom Alert Modal Elements
        let customAlertModal;
        let alertTitle;
        let alertMessage;
        let alertCloseButton;
        let loadingModal;

        // Function to show custom alert modal
        function showAlert(title, message, isError = true) {
            alertTitle.textContent = title;
            alertTitle.style.color = isError ? '#ef4444' : '#22c55e';
            alertMessage.textContent = message;
            customAlertModal.classList.add('show');
        }

        // Function to hide custom alert modal
        function hideAlert() {
            customAlertModal.classList.remove('show');
        }

        // Function to show loading modal
        function showLoading() {
            loadingModal.classList.add('show');
        }

        // Function to hide loading modal
        function hideLoading() {
            loadingModal.classList.remove('show');
        }

        // 場名・店名入力フィールドを更新する関数
        function updateLocationInput() {
            const selectedCategory = categorySelect.value;
            const locations = locationData[selectedCategory];
            const isRequired = visibilityMatrix[selectedCategory]?.["location-store"]?.required || false;

            locationStoreInputContainer.innerHTML = '';

            if (locations && locations.length > 0) {
                const selectElement = document.createElement('select');
                selectElement.id = 'location-store-input';
                selectElement.className = 'rounded-lg w-full';
                if (isRequired) selectElement.setAttribute('required', 'required');

                const defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = "選択してください";
                selectElement.appendChild(defaultOption);

                locations.forEach(location => {
                    const option = document.createElement('option');
                    option.value = location;
                    option.textContent = location;
                    selectElement.appendChild(option);
                });
                locationStoreInputContainer.appendChild(selectElement);

                selectElement.addEventListener('change', updateHorseNameInput);

            } else {
                const inputElement = document.createElement('input');
                inputElement.type = 'text';
                inputElement.id = 'location-store-input';
                inputElement.placeholder = "場名・店名を入力";
                inputElement.className = 'rounded-lg w-full';
                if (isRequired) inputElement.setAttribute('required', 'required');
                locationStoreInputContainer.appendChild(inputElement);
            }
            updateHorseNameInput(); // Location might affect Horse Name, so update it
        }

        // クラス入力フィールドを更新する関数
        function updateClassInput() {
            const selectedCategory = categorySelect.value;
            const classes = classData[selectedCategory];
            const isRequired = visibilityMatrix[selectedCategory]?.["class"]?.required || false;

            classInputContainer.innerHTML = '';

            if (classes && classes.length > 0) {
                const selectElement = document.createElement('select');
                selectElement.id = 'class-input';
                selectElement.className = 'rounded-lg w-full';
                if (isRequired) selectElement.setAttribute('required', 'required');

                const defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = "選択してください";
                selectElement.appendChild(defaultOption);

                classes.forEach(cls => {
                    const option = document.createElement('option');
                    option.value = cls;
                    option.textContent = cls;
                    selectElement.appendChild(option);
                });
                classInputContainer.appendChild(selectElement);
            } else {
                const inputElement = document.createElement('input');
                inputElement.type = 'text';
                inputElement.id = 'class-input';
                inputElement.placeholder = "クラスを入力";
                inputElement.className = 'rounded-lg w-full';
                if (isRequired) inputElement.setAttribute('required', 'required');
                classInputContainer.appendChild(inputElement);
            }
        }

        // レース名入力フィールドを更新する関数
        function updateRaceNameInput() {
            const selectedCategory = categorySelect.value;
            const raceNames = raceNameData[selectedCategory];
            const isRequired = visibilityMatrix[selectedCategory]?.["race-name"]?.required || false;

            raceNameInputContainer.innerHTML = '';

            if (raceNames && raceNames.length > 0) {
                const selectElement = document.createElement('select');
                selectElement.id = 'race-name-input';
                selectElement.className = 'rounded-lg w-full';
                if (isRequired) selectElement.setAttribute('required', 'required');

                const defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = "選択してください";
                selectElement.appendChild(defaultOption);

                raceNames.forEach(raceName => {
                    const option = document.createElement('option');
                    option.value = raceName;
                    option.textContent = raceName;
                    selectElement.appendChild(option);
                });
                raceNameInputContainer.appendChild(selectElement);
            } else {
                const inputElement = document.createElement('input');
                inputElement.type = 'text';
                inputElement.id = 'race-name-input';
                inputElement.placeholder = "レース名を入力";
                inputElement.className = 'rounded-lg w-full';
                if (isRequired) inputElement.setAttribute('required', 'required');
                raceNameInputContainer.appendChild(inputElement);
            }
        }

        // 馬場入力フィールドを更新する関数
        function updateHorseNameInput() {
            const selectedCategory = categorySelect.value;
            const locationInput = document.getElementById('location-store-input');
            let selectedLocation = '';

            if (locationInput && locationInput.tagName === 'SELECT') {
                selectedLocation = locationInput.value;
            } else if (locationInput && locationInput.tagName === 'INPUT') {
                selectedLocation = locationInput.value;
            }

            const categorySpecificHorseData = horseNameData[selectedCategory] || {};
            const horseNames = categorySpecificHorseData[selectedLocation];
            const isRequired = visibilityMatrix[selectedCategory]?.["horse-name"]?.required || false;

            horseNameInputContainer.innerHTML = '';

            if (horseNames && horseNames.length > 0) {
                const selectElement = document.createElement('select');
                selectElement.id = 'horse-name-input';
                selectElement.className = 'rounded-lg w-full';
                if (isRequired) selectElement.setAttribute('required', 'required');

                if (horseNames.length === 1) {
                    const option = document.createElement('option');
                    option.value = horseNames[0];
                    option.textContent = horseNames[0];
                    selectElement.appendChild(option);
                    selectElement.value = horseNames[0];
                    selectElement.disabled = true;
                } else {
                    const defaultOption = document.createElement('option');
                    defaultOption.value = "";
                    defaultOption.textContent = "選択してください";
                    selectElement.appendChild(defaultOption);

                    horseNames.forEach(horseName => {
                        const option = document.createElement('option');
                        option.value = horseName;
                        option.textContent = horseName;
                        selectElement.appendChild(option);
                    });
                }
                horseNameInputContainer.appendChild(selectElement);
            } else {
                const inputElement = document.createElement('input');
                inputElement.type = 'text';
                inputElement.id = 'horse-name-input';
                inputElement.placeholder = "馬場を入力";
                inputElement.className = 'rounded-lg w-full';
                if (isRequired) inputElement.setAttribute('required', 'required');
                horseNameInputContainer.appendChild(inputElement);
            }
        }

        // 距離ジャンルを更新する関数
        function updateDistanceGenre() {
            const selectedDistanceStr = distanceSelect.value;
            const selectedDistance = parseInt(selectedDistanceStr);

            if (isNaN(selectedDistance)) {
                distanceGenreInput.value = '';
                return;
            }

            let genre = "";
            if (selectedDistanceStr === "その他") {
                genre = "その他";
            } else if (selectedDistance >= distanceGenreData["Sprint(スプリント)"][0] && selectedDistance <= distanceGenreData["Sprint(スプリント)"][1]) {
                genre = "Sprint(スプリント)";
            } else if (selectedDistance >= distanceGenreData["Mile(マイル)"][0] && selectedDistance <= distanceGenreData["Mile(マイル)"][1]) {
                genre = "Mile(マイル)";
            } else if (selectedDistance >= distanceGenreData["Intermediate(インターミディエイト)"][0] && selectedDistance <= distanceGenreData["Intermediate(インターmEdiate)"][1]) {
                genre = "Intermediate(インターミディエイト)";
            } else if (selectedDistance >= distanceGenreData["Long(ロング)"][0] && selectedDistance <= distanceGenreData["Long(ロング)"][1]) {
                genre = "Long(ロング)";
            } else if (selectedDistance >= distanceGenreData["Extended(エクステンデッド)"][0]) {
                genre = "Extended(エクステンデッド)";
            } else if (selectedDistanceStr === "820") {
                genre = "Sprint(スプリント)";
            }

            distanceGenreInput.value = genre;
        }

        // 条件入力フィールドを更新する関数
        function updateConditionInput() {
            const selectedCategory = categorySelect.value;
            const conditions = conditionData[selectedCategory];
            const isRequired = visibilityMatrix[selectedCategory]?.["condition"]?.required || false;

            conditionInputContainer.innerHTML = '';

            if (conditions && conditions.length > 0) {
                const selectElement = document.createElement('select');
                selectElement.id = 'condition-input';
                selectElement.className = 'rounded-lg w-full';
                if (isRequired) selectElement.setAttribute('required', 'required');

                const defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = "選択してください";
                selectElement.appendChild(defaultOption);

                conditions.forEach(condition => {
                    const option = document.createElement('option');
                    option.value = condition;
                    option.textContent = condition;
                    selectElement.appendChild(option);
                });
                conditionInputContainer.appendChild(selectElement);
            } else {
                const inputElement = document.createElement('input');
                inputElement.type = 'text';
                inputElement.id = 'condition-input';
                inputElement.placeholder = "条件を入力";
                inputElement.className = 'rounded-lg w-full';
                if (isRequired) inputElement.setAttribute('required', 'required');
                conditionInputContainer.appendChild(inputElement);
            }
        }

        // 日付関連のフィールドを更新する関数
        function updateDateFields() {
            const dateValue = dateInput.value;
            if (dateValue) {
                const date = new Date(dateValue);
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');

                dateDbInput.value = `${year}年${month}月${day}日`;
                yearDbInput.value = `${year}年`;
                monthDateDbInput.value = `${year}年${month}月`;
            } else {
                dateDbInput.value = '';
                yearDbInput.value = '';
                monthDateDbInput.value = '';
            }
        }

        // タイプ入力フィールドを初期化・更新する関数
        function initializeTypeField(initialValue = '') {
            typeInputContainer.innerHTML = '';
            const selectedCategory = categorySelect.value;
            const isRequired = visibilityMatrix[selectedCategory]?.["type"]?.required || false;

            const selectElement = document.createElement('select');
            selectElement.id = 'type-input';
            selectElement.className = 'rounded-lg w-full';
            if (isRequired) selectElement.setAttribute('required', 'required');

            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.textContent = "選択してください";
            selectElement.appendChild(defaultOption);

            typeOptions.forEach(optionText => {
                const option = document.createElement('option');
                option.value = optionText;
                option.textContent = optionText;
                selectElement.appendChild(option);
            });

            const otherOption = document.createElement('option');
            otherOption.value = "その他";
            otherOption.textContent = "その他";
            selectElement.appendChild(otherOption);

            selectElement.addEventListener('change', () => {
                if (selectElement.value === "その他") {
                    const inputElement = document.createElement('input');
                    inputElement.type = 'text';
                    inputElement.id = 'type-input';
                    inputElement.placeholder = "タイプを入力";
                    inputElement.className = 'rounded-lg w-full';
                    if (isRequired) inputElement.setAttribute('required', 'required');
                    typeInputContainer.innerHTML = '';
                    typeInputContainer.appendChild(inputElement);
                    inputElement.focus();
                }
            });

            typeInputContainer.appendChild(selectElement);

            if (initialValue) {
                if (typeOptions.includes(initialValue)) {
                    selectElement.value = initialValue;
                } else {
                    selectElement.value = "その他";
                    const event = new Event('change');
                    selectElement.dispatchEvent(event);
                    const inputElement = document.getElementById('type-input');
                    if (inputElement && inputElement.tagName === 'INPUT') {
                        inputElement.value = initialValue;
                    }
                }
            }
        }

        // メーカー入力フィールドを初期化・更新する関数
        function initializeManufacturerField(initialValue = '') {
            manufacturerInputContainer.innerHTML = '';
            const selectedCategory = categorySelect.value;
            const isRequired = visibilityMatrix[selectedCategory]?.["manufacturer"]?.required || false;

            const selectElement = document.createElement('select');
            selectElement.id = 'manufacturer-input';
            selectElement.className = 'rounded-lg w-full';
            if (isRequired) selectElement.setAttribute('required', 'required');

            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.textContent = "選択してください";
            selectElement.appendChild(defaultOption);

            manufacturerOptions.forEach(optionText => {
                const option = document.createElement('option');
                option.value = optionText;
                option.textContent = optionText;
                selectElement.appendChild(option);
            });

            const otherOption = document.createElement('option');
            otherOption.value = "その他";
            otherOption.textContent = "その他";
            selectElement.appendChild(otherOption);

            selectElement.addEventListener('change', () => {
                if (selectElement.value === "その他") {
                    const inputElement = document.createElement('input');
                    inputElement.type = 'text';
                    inputElement.id = 'manufacturer-input';
                    inputElement.placeholder = "メーカーを入力";
                    inputElement.className = 'rounded-lg w-full';
                    if (isRequired) inputElement.setAttribute('required', 'required');
                    manufacturerInputContainer.innerHTML = '';
                    manufacturerInputContainer.appendChild(inputElement);
                    inputElement.focus();
                }
            });

            manufacturerInputContainer.appendChild(selectElement);

            if (initialValue) {
                if (manufacturerOptions.includes(initialValue)) {
                    selectElement.value = initialValue;
                } else {
                    selectElement.value = "その他";
                    const event = new Event('change');
                    selectElement.dispatchEvent(event);
                    const inputElement = document.getElementById('manufacturer-input');
                    if (inputElement && inputElement.tagName === 'INPUT') {
                        inputElement.value = initialValue;
                    }
                }
            }
        }


        // 機種選択に基づいてタイプとメーカーを自動反映する関数
        function autoFillTypeAndManufacturer() {
            const deviceTypeInput = document.getElementById('device-type-input');
            const selectedDevice = deviceTypeInput ? deviceTypeInput.value : '';

            const details = deviceTypeDetails[selectedDevice];
            const typeValue = details ? details.type : '';
            const manufacturerValue = details ? details.manufacturer : '';

            initializeTypeField(typeValue);
            initializeManufacturerField(manufacturerValue);
        }

        // 機種入力フィールドを更新する関数
        function updateDeviceTypeInput() {
            const selectedCategory = categorySelect.value;
            const isPachinkoOrSlot = ["パチンコ", "スロット"].includes(selectedCategory);
            const isRequired = visibilityMatrix[selectedCategory]?.["device-type"]?.required || false;

            deviceTypeInputContainer.innerHTML = '';

            if (isPachinkoOrSlot) {
                const selectElement = document.createElement('select');
                selectElement.id = 'device-type-input';
                selectElement.className = 'rounded-lg w-full';
                if (isRequired) selectElement.setAttribute('required', 'required');

                const defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = "選択してください";
                selectElement.appendChild(defaultOption);

                allDeviceTypes.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device;
                    option.textContent = device;
                    selectElement.appendChild(option);
                });

                const otherOption = document.createElement('option');
                otherOption.value = "その他";
                otherOption.textContent = "その他";
                selectElement.appendChild(otherOption);

                selectElement.addEventListener('change', () => {
                    if (selectElement.value === "その他") {
                        const inputElement = document.createElement('input');
                        inputElement.type = 'text';
                        inputElement.id = 'device-type-input';
                        inputElement.placeholder = "機種を入力";
                        inputElement.className = 'rounded-lg w-full';
                        if (isRequired) inputElement.setAttribute('required', 'required');
                        deviceTypeInputContainer.innerHTML = '';
                        deviceTypeInputContainer.appendChild(inputElement);
                        inputElement.focus();
                    }
                    autoFillTypeAndManufacturer();
                });
                deviceTypeInputContainer.appendChild(selectElement);
            } else {
                const inputElement = document.createElement('input');
                inputElement.type = 'text';
                inputElement.id = 'device-type-input';
                inputElement.placeholder = "機種を入力";
                inputElement.className = 'rounded-lg w-full';
                if (isRequired) inputElement.setAttribute('required', 'required');
                deviceTypeInputContainer.appendChild(inputElement);
                inputElement.addEventListener('input', autoFillTypeAndManufacturer);
            }
            autoFillTypeAndManufacturer();
        }

        // 収支を計算して表示する関数
        function updateBalance() {
            const expense = parseFloat(expenseInput.value) || 0;
            const income = parseFloat(incomeInput.value) || 0;
            const balance = income - expense;
            balanceInput.value = balance.toLocaleString();
            if (balance < 0) {
                balanceInput.style.color = '#ef4444';
            } else if (balance > 0) {
                balanceInput.style.color = '#22c55e';
            } else {
                balanceInput.style.color = '#cccccc';
            }
        }

        // フィールドの表示/非表示を切り替えるメイン関数
        function updateFieldVisibility() {
            const selectedCategory = categorySelect.value;
            console.log(`Debug: --- Entering updateFieldVisibility ---`);
            console.log(`Debug: selectedCategory at start of updateFieldVisibility: "${selectedCategory}"`);
            const categoryVisibility = visibilityMatrix[selectedCategory];
            console.log(`Debug: categoryVisibility for "${selectedCategory}":`, categoryVisibility);

            // 全てのフィールドをデフォルトで非表示にする
            for (const key in formGroups) {
                if (formGroups[key]) {
                    formGroups[key].classList.add('hidden');
                    const inputOrSelect = formGroups[key].querySelector('input, select');
                    if (inputOrSelect) { 
                        inputOrSelect.removeAttribute('required');
                    }
                    const requiredMark = formGroups[key].querySelector('.required-mark');
                    if (requiredMark) {
                        requiredMark.classList.add('hidden');
                    }
                    console.log(`Debug: Field group "${key}" set to hidden by default.`);
                } else {
                    console.warn(`Warning: formGroup for key "${key}" is null during initial hiding.`);
                }
            }

            // カテゴリフィールドは常に表示し、必須とする
            const categoryFormGroup = document.getElementById('category-form-group');
            const categoryRequiredMark = document.getElementById('category-required');
            const categorySelectElement = document.getElementById('category-select');

            if (categoryFormGroup) {
                categoryFormGroup.classList.remove('hidden');
                console.log(`Debug: Category form group set to visible.`);
            }
            if (categoryRequiredMark) {
                categoryRequiredMark.classList.remove('hidden');
                console.log(`Debug: Category required mark shown.`);
            }
            if (categorySelectElement) {
                categorySelectElement.setAttribute('required', 'required');
                console.log(`Debug: Category select element set to required.`);
            }


            // 選択されたカテゴリに基づいてその他のフィールドの表示を切り替える
            if (categoryVisibility && selectedCategory !== "") { // カテゴリが選択されている場合のみ
                console.log(`Debug: Processing visibility for category: ${selectedCategory}`);
                for (const fieldName in categoryVisibility) {
                    // カテゴリ自体は上記で処理済みなのでスキップ
                    if (fieldName === "category") continue; 

                    const fieldSetting = categoryVisibility[fieldName];
                    const formGroupElement = formGroups[fieldName];

                    if (formGroupElement) { // formGroupElementがnullでないことを確認
                        if (fieldSetting.visible) {
                            formGroupElement.classList.remove('hidden');
                            console.log(`Debug: Field group "${fieldName}" set to visible.`);
                            
                            if (fieldSetting.required) {
                                if (["date-db", "year-db", "month-date-db", "balance"].includes(fieldName)) {
                                    console.log(`Debug: Field "${fieldName}" is visible (readonly).`);
                                } else {
                                    let inputElement = null;
                                    if (fieldName === 'title' || fieldName === 'date' || fieldName === 'expense' || fieldName === 'income' || fieldName === 'media' || fieldName === 'memo' || fieldName === 'betting-type' || fieldName === 'distance' || fieldName === 'event-date' || fieldName === 'race-number') {
                                        inputElement = document.getElementById(fieldName + ((fieldName === 'betting-type' || fieldName === 'distance' || fieldName === 'event-date' || fieldName === 'race-number') ? '-select' : '-input'));
                                    } else {
                                        const container = document.getElementById(fieldName + '-input-container');
                                        if (container) {
                                            inputElement = container.querySelector('input, select');
                                        }
                                    }
                                    
                                    if (inputElement) {
                                        inputElement.setAttribute('required', 'required');
                                        console.log(`Debug: Field "${fieldName}" is visible and required.`);
                                    } else {
                                        console.warn(`Warning: Could not find input/select element for required field "${fieldName}". Check ID or dynamic generation.`);
                                    }
                                }
                            } else {
                                console.log(`Debug: Field "${fieldName}" is visible but not required.`);
                            }
                            const requiredMark = formGroupElement.querySelector('.required-mark');
                            if (requiredMark && fieldSetting.required) {
                                requiredMark.classList.remove('hidden');
                                console.log(`Debug: Required mark shown for "${fieldName}".`);
                            }
                        } else {
                            console.log(`Debug: Field group "${fieldName}" remains hidden (not visible for category).`);
                        }
                    } else {
                        console.warn(`Warning: formGroup for key "${fieldName}" is null during visibility update.`);
                    }
                }
            } else {
                console.log(`Debug: No specific category selected, keeping most fields hidden.`);
            }
            
            const relevantCategories = ["競馬", "地方競馬", "競艇", "競輪", "オートレース"];
            if (relevantCategories.includes(selectedCategory)) {
                webSearchButton.style.display = 'flex';
                console.log(`Debug: Web search button displayed.`);
            } else {
                webSearchButton.style.display = 'none';
                console.log(`Debug: Web search button hidden.`);
            }

            // 動的なフィールドの更新は、カテゴリが選択されているかに関わらず実行する必要がある
            // ただし、選択肢はselectedCategoryに依存する
            updateLocationInput();
            updateClassInput();
            updateRaceNameInput();
            updateDateFields();
            updateDistanceGenre();
            updateConditionInput();
            updateDeviceTypeInput();
            initializeTypeField();
            initializeManufacturerField();
            updateBalance();
            console.log("Debug: Dynamic field updates triggered.");
        }

        // Function to set today's date as default for the date input
        function setTodayDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            const day = today.getDate().toString().padStart(2, '0');
            dateInput.value = `${year}-${month}-${day}`;
            updateDateFields();
        }


        // ページ読み込み時に初期状態を設定
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Debug: DOMContentLoaded event fired.");

            // すべてのDOM要素をここで取得し、グローバル変数に割り当てる
            categorySelect = document.getElementById('category-select');
            expenseForm = document.getElementById('expense-form');
            locationStoreInputContainer = document.getElementById('location-store-input-container');
            classInputContainer = document.getElementById('class-input-container');
            raceNameInputContainer = document.getElementById('race-name-input-container');
            horseNameInputContainer = document.getElementById('horse-name-input-container');
            distanceSelect = document.getElementById('distance-select');
            distanceGenreInput = document.getElementById('distance-genre-input');
            conditionInputContainer = document.getElementById('condition-input-container');
            deviceTypeInputContainer = document.getElementById('device-type-input-container');
            typeInputContainer = document.getElementById('type-input-container');
            manufacturerInputContainer = document.getElementById('manufacturer-input-container');
            dateInput = document.getElementById('date-input');
            dateDbInput = document.getElementById('date-db-input');
            yearDbInput = document.getElementById('year-db-input');
            monthDateDbInput = document.getElementById('month-date-db-input');
            expenseInput = document.getElementById('expense-input');
            incomeInput = document.getElementById('income-input');
            balanceInput = document.getElementById('balance-input');
            webSearchButton = document.getElementById('web-search-button');
            customAlertModal = document.getElementById('custom-alert-modal');
            alertTitle = document.getElementById('alert-title');
            alertMessage = document.getElementById('alert-message');
            alertCloseButton = document.getElementById('alert-close-button');
            loadingModal = document.getElementById('loading-modal');

            // formGroupsマップもここで初期化
            formGroups = {
                "title": document.getElementById('title-form-group'),
                "category": categorySelect.closest('.form-group'), // ここでcategoryFormGroupを取得
                "date": document.getElementById('date-form-group'),
                "date-db": document.getElementById('date-db-form-group'), 
                "year-db": document.getElementById('year-db-form-group'), 
                "month-date-db": document.getElementById('month-date-db-form-group'), 
                "location-store": document.getElementById('location-store-form-group'),
                "event-date": document.getElementById('event-date-form-group'),
                "race-number": document.getElementById('race-number-form-group'),
                "race-name": document.getElementById('race-name-form-group'),
                "class": document.getElementById('class-form-group'),
                "distance": document.getElementById('distance-form-group'),
                "distance-genre": document.getElementById('distance-genre-form-group'),
                "condition": document.getElementById('condition-form-group'),
                "horse-name": document.getElementById('horse-name-form-group'),
                "betting-type": document.getElementById('betting-type-form-group'),
                "expense": document.getElementById('expense-form-group'),
                "income": document.getElementById('income-form-group'),
                "balance": document.getElementById('balance-form-group'),
                "device-type": document.getElementById('device-type-form-group'),
                "type": document.getElementById('type-form-group'),
                "manufacturer": document.getElementById('manufacturer-form-group'),
                "media": document.getElementById('media-form-group'),
                "memo": document.getElementById('memo-form-group')
            };

            // 全ての要素が取得できたかログで確認
            for (const key in formGroups) {
                if (!formGroups[key]) {
                    console.error(`Error: Form group element for key "${key}" not found during DOMContentLoaded initialization.`);
                }
            }
            if (!categorySelect) console.error("Error: categorySelect element not found!");
            if (!expenseForm) console.error("Error: expenseForm element not found!");

            setTodayDate();
            
            // カテゴリのデフォルト値を解除し、"選択してください"にする
            categorySelect.value = "";
            console.log(`Debug: After setting categorySelect.value to empty, current value: "${categorySelect.value}"`);
            
            // 明示的にchangeイベントをディスパッチして、updateFieldVisibilityをトリガー
            // これにより、カテゴリが未選択の状態で、カテゴリフィールドのみが表示されるようになる
            const event = new Event('change');
            categorySelect.dispatchEvent(event);
            console.log(`Debug: 'change' event dispatched on categorySelect.`);

            // Close button event listener for the alert modal - DOMContentLoaded内へ移動
            alertCloseButton.addEventListener('click', hideAlert);
            customAlertModal.addEventListener('click', (event) => {
                if (event.target === customAlertModal) {
                    hideAlert();
                }
            });

            // Add event listeners for expense and income to update balance
            expenseInput.addEventListener('input', updateBalance);
            incomeInput.addEventListener('input', updateBalance);

            // カテゴリーが変更されたときに全フィールドの表示/非表示と動的な入力フィールドを更新
            categorySelect.addEventListener('change', updateFieldVisibility);

            // Date入力が変更されたときに日付関連フィールドを更新
            dateInput.addEventListener('change', updateDateFields);

            // 距離が変更されたときに距離ジャンルを更新
            distanceSelect.addEventListener('change', updateDistanceGenre);

            // Add event listener for the web search button
            webSearchButton.addEventListener('click', () => {
                const selectedCategory = categorySelect.value;
                const dateValue = dateInput.value;
                const locationInput = document.getElementById('location-store-input');
                const locationName = locationInput ? locationInput.value : '';
                const raceNumberSelect = document.getElementById('race-number-select');
                const raceNumber = raceNumberSelect ? raceNumberSelect.value : '';

                if (!dateValue || !locationName || !raceNumber) {
                    showAlert("エラー", "日付、場名・店名、レース番号は検索のために必須です。", true);
                    return;
                }

                const dateObj = new Date(dateValue);
                const year = dateObj.getFullYear();
                const month = (dateObj.getMonth() + 1).toString();
                const day = dateObj.getDate().toString();

                let formattedDate = `${year}年${month}月${day}日`;

                let searchQuery = `${formattedDate} ${locationName} ${raceNumber}`;

                let siteFilter = '';
                switch (selectedCategory) {
                    case "競馬":
                        siteFilter = "site:jra.go.jp OR site:netkeiba.com";
                        break;
                    case "地方競馬":
                        siteFilter = "site:netkeiba.com";
                        break;
                    case "競艇":
                        siteFilter = "site:boatrace.jp";
                        break;
                    case "競輪":
                        siteFilter = "site:keirin.kdreams.jp";
                        break;
                }

                const fullQuery = encodeURIComponent(`${searchQuery} ${siteFilter}`).replace(/%20OR%20/g, '+OR+').replace(/%3A/g, ':'); 

                const googleUrl = `https://www.google.com/search?q=${fullQuery}`;
                window.open(googleUrl, '_blank');
            });

            // フォーム送信時のバリデーション
            expenseForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                
                const selectedCategory = categorySelect.value;
                const currentVisibility = visibilityMatrix[selectedCategory];
                const missingFields = [];

                // カテゴリ自体が未選択の場合は、即座にエラーメッセージを追加
                if (!selectedCategory) {
                    missingFields.push(document.querySelector('#category-form-group label').textContent.replace('*', '').trim());
                }

                for (const fieldName in currentVisibility) {
                    // カテゴリは上記で既にチェック済み
                    if (fieldName === "category") continue;

                    const fieldSetting = currentVisibility[fieldName];
                    const formGroupElement = formGroups[fieldName];
                    
                    if (formGroupElement && !formGroupElement.classList.contains('hidden') && fieldSetting.required) {
                        let fieldValue = '';
                        let element = null;

                        // ここでのfieldNameはcategoryではないため、category-selectは直接対象外
                        if (fieldName === 'race-number') {
                            element = document.getElementById('race-number-select');
                        } else if (document.getElementById(fieldName + '-input')) {
                            element = document.getElementById(fieldName + '-input');
                        } else if (document.getElementById(fieldName + '-select')) {
                            element = document.getElementById(fieldName + '-select');
                        } else {
                            const container = document.getElementById(fieldName + '-input-container');
                            if (container) {
                                element = container.querySelector('input, select');
                            }
                        }

                        if (["date-db", "year-db", "month-date-db", "balance"].includes(fieldName)) {
                            continue;
                        }
                        
                        if (element) {
                            let tempValueBeforeTrim = element.value;
                            fieldValue = tempValueBeforeTrim;
                            console.log(`Debug: [${fieldName}] (Before Trim) fieldValue = "${fieldValue}"`);
                            if (typeof fieldValue === 'string') {
                                fieldValue = fieldValue.trim();
                            }
                            console.log(`Debug: [${fieldName}] (After Trim) fieldValue = "${fieldValue}"`);
                        } else {
                            console.warn(`Warning: Input element for fieldName '${fieldName}' not found during validation.`);
                        }

                        if (!fieldValue) {
                            const labelElement = formGroupElement.querySelector('label');
                            if (labelElement) {
                                const labelText = labelElement.textContent.replace('*', '').replace(':', '').trim();
                                missingFields.push(labelText);
                            } else {
                                missingFields.push(fieldName);
                            }
                        }
                    }
                }

                if (missingFields.length > 0) {
                    const message = `以下の必須項目が未入力です。\n\n- ${missingFields.join('\n- ')}`;
                    showAlert("入力エラー", message, true);
                } else {
                    showLoading();
                    try {
                        const formData = {
                            title: document.getElementById('title-input')?.value || '',
                            category: document.getElementById('category-select')?.value || '',
                            date: document.getElementById('date-input')?.value || '',
                            dateDb: document.getElementById('date-db-input')?.value || '',
                            yearDb: document.getElementById('year-db-input')?.value || '',
                            monthDateDb: document.getElementById('month-date-db-input')?.value || '',
                            locationStore: document.getElementById('location-store-input') ? document.getElementById('location-store-input').value : '',
                            raceNumber: document.getElementById('race-number-select') ? document.getElementById('race-number-select').value : '',
                            eventDate: document.getElementById('event-date-select') ? document.getElementById('event-date-select').value : '',
                            raceName: document.getElementById('race-name-input') ? document.getElementById('race-name-input').value : '',
                            class: document.getElementById('class-input') ? document.getElementById('class-input').value : '',
                            horseName: document.getElementById('horse-name-input') ? document.getElementById('horse-name-input').value : '',
                            distance: document.getElementById('distance-select') ? document.getElementById('distance-select').value : '',
                            distanceGenre: document.getElementById('distance-genre-input') ? document.getElementById('distance-genre-input').value : '',
                            condition: document.getElementById('condition-input') ? document.getElementById('condition-input').value : '',
                            bettingType: document.getElementById('betting-type-select') ? document.getElementById('betting-type-select').value : '',
                            expense: document.getElementById('expense-input')?.value || '',
                            income: document.getElementById('income-input')?.value || '',
                            deviceType: document.getElementById('device-type-input') ? document.getElementById('device-type-input').value : '',
                            type: document.getElementById('type-input') ? document.getElementById('type-input').value : '',
                            manufacturer: document.getElementById('manufacturer-input') ? document.getElementById('manufacturer-input').value : '',
                            media: document.getElementById('media-input')?.value || '',
                            memo: document.getElementById('memo-input')?.value || ''
                        };

                        formData.balance = (parseFloat(formData.income) || 0) - (parseFloat(formData.expense) || 0);

                        console.log("Debug: Final formData for submission:", formData);
                        console.log("Debug: Attempting to fetch to GAS_WEB_APP_URL:", GAS_WEB_APP_URL);


                        const response = await fetch(GAS_WEB_APP_URL, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(formData),
                        });

                        const result = await response.json();

                        if (result.success) {
                            showAlert("送信完了", "Notionにデータを送信しました。\n\n" + result.message, false);
                            expenseForm.reset();
                            setTodayDate();
                            // categorySelectの値をリセット後に再設定し、changeイベントをトリガー
                            categorySelect.value = ""; 
                            categorySelect.dispatchEvent(new Event('change'));
                            updateBalance();
                        } else {
                            showAlert("送信失敗", "データの送信に失敗しました:\n\n" + result.message, true);
                        }
                    } catch (error) {
                        console.error('Error sending data to GAS:', error);
                        showAlert("エラー", "データの送信中にエラーが発生しました。\n\nネットワーク接続を確認するか、後でもう一度お試しください。", true);
                    } finally {
                        hideLoading();
                    }
                }
            });
        });
    </script>
</body>
</html>
